<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hindi SRS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --border: #475569;
      --hindi-font: 'Noto Sans Devanagari', sans-serif;
      --ui-font: 'Inter', system-ui, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--ui-font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 600px;
      padding: 1rem;
    }

    header {
      text-align: center;
      padding: 1.5rem 0 1rem;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    header .subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* Dashboard */
    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
      font-family: var(--ui-font);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      width: 100%;
      margin-top: 1rem;
    }

    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
    }

    /* Exercise card */
    .exercise-card {
      background: var(--bg-card);
      border-radius: 1rem;
      padding: 2rem;
      margin: 1rem 0;
      text-align: center;
    }

    .exercise-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--bg-input);
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .exercise-prompt {
      font-family: var(--hindi-font);
      font-size: 1.75rem;
      line-height: 1.6;
      margin: 1rem 0;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--bg-input);
      border-radius: 2px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-bar .fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* MCQ Options */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 1.5rem 0;
    }

    .mcq-option {
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      font-size: 1.1rem;
      font-family: var(--hindi-font);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }

    .mcq-option:hover { border-color: var(--accent); }
    .mcq-option.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.15); }
    .mcq-option.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.15); }
    .mcq-option.incorrect { border-color: var(--error); background: rgba(239, 68, 68, 0.15); }

    /* Text input */
    .answer-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text);
      font-size: 1.25rem;
      font-family: var(--hindi-font);
      outline: none;
      margin: 1rem 0;
    }

    .answer-input:focus { border-color: var(--accent); }

    /* Feedback */
    .feedback {
      padding: 1rem;
      border-radius: 0.75rem;
      margin: 1rem 0;
      text-align: center;
    }

    .feedback.correct {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .feedback.incorrect {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
    }

    .feedback .correct-answer {
      font-family: var(--hindi-font);
      font-size: 1.25rem;
      margin-top: 0.5rem;
      color: var(--text);
    }

    /* Rating buttons */
    .rating-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .rating-btn {
      padding: 0.75rem 0.5rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      font-size: 0.875rem;
      font-family: var(--ui-font);
      transition: all 0.15s;
    }

    .rating-btn:hover { border-color: var(--accent); }
    .rating-btn .rating-num { font-size: 1.25rem; font-weight: 700; }
    .rating-btn .rating-label { font-size: 0.6875rem; color: var(--text-muted); }
    .rating-btn.r1 { border-color: var(--error); }
    .rating-btn.r2 { border-color: var(--warning); }
    .rating-btn.r3 { border-color: var(--success); }
    .rating-btn.r4 { border-color: var(--accent); }

    /* Session summary */
    .summary-card {
      background: var(--bg-card);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      margin: 1rem 0;
    }

    .summary-card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 1rem 0;
    }

    .summary-stat .value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .summary-stat .label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .accuracy-correct { color: var(--success); }
    .accuracy-incorrect { color: var(--error); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Hindi SRS</h1>
      <div class="subtitle">Spaced Repetition for Hindi</div>
    </header>

    <!-- Dashboard Screen -->
    <div id="dashboard" class="screen active">
      <div class="stat-grid">
        <div class="stat-card">
          <div class="value" id="stat-due">-</div>
          <div class="label">Due Now</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-new">-</div>
          <div class="label">New Cards</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-total">-</div>
          <div class="label">Total Cards</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-streak">-</div>
          <div class="label">Day Streak</div>
        </div>
      </div>
      <button class="btn btn-primary" id="start-btn" onclick="startSession()">Start Review</button>
    </div>

    <!-- Review Screen -->
    <div id="review" class="screen">
      <div class="progress-bar"><div class="fill" id="progress-fill"></div></div>
      <div class="progress-text" id="progress-text">0 / 0</div>

      <div class="exercise-card">
        <div class="exercise-type-badge" id="exercise-type">MCQ</div>
        <div class="exercise-prompt" id="exercise-prompt"></div>
      </div>

      <!-- MCQ options -->
      <div id="mcq-container" class="mcq-options" style="display:none;"></div>

      <!-- Text input -->
      <div id="text-container" style="display:none;">
        <input type="text" class="answer-input" id="answer-input"
               placeholder="Type your answer..." autocomplete="off">
        <button class="btn btn-primary" id="submit-btn" onclick="submitTextAnswer()">Submit</button>
      </div>

      <!-- Feedback -->
      <div id="feedback-container" style="display:none;"></div>

      <!-- Rating buttons -->
      <div id="rating-container" style="display:none;">
        <div style="text-align:center;font-size:0.875rem;color:var(--text-muted);margin-bottom:0.5rem;">Rate your recall:</div>
        <div class="rating-buttons">
          <button class="rating-btn r1" onclick="submitRating(1)">
            <div class="rating-num">1</div><div class="rating-label">Again</div>
          </button>
          <button class="rating-btn r2" onclick="submitRating(2)">
            <div class="rating-num">2</div><div class="rating-label">Hard</div>
          </button>
          <button class="rating-btn r3" onclick="submitRating(3)">
            <div class="rating-num">3</div><div class="rating-label">Good</div>
          </button>
          <button class="rating-btn r4" onclick="submitRating(4)">
            <div class="rating-num">4</div><div class="rating-label">Easy</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summary" class="screen">
      <div class="summary-card">
        <h2>Session Complete</h2>
        <div class="summary-stats">
          <div class="summary-stat">
            <div class="value accuracy-correct" id="sum-correct">0</div>
            <div class="label">Correct</div>
          </div>
          <div class="summary-stat">
            <div class="value accuracy-incorrect" id="sum-incorrect">0</div>
            <div class="label">Incorrect</div>
          </div>
          <div class="summary-stat">
            <div class="value" id="sum-accuracy">0%</div>
            <div class="label">Accuracy</div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="showDashboard()">Back to Dashboard</button>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let sessionId = null;
    let currentExercise = null;
    let totalCards = 0;
    let reviewed = 0;
    let sessionCorrect = 0;
    let sessionIncorrect = 0;
    let answerStartTime = 0;
    let currentResponse = '';
    const LEARNER_ID = 1;

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API}/api/stats/${LEARNER_ID}`);
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('stat-due').textContent = data.cards_due;
        document.getElementById('stat-new').textContent = data.cards_new;
        document.getElementById('stat-total').textContent = data.total_cards;
        document.getElementById('stat-streak').textContent = data.streak_days;
        document.getElementById('start-btn').disabled = (data.cards_due + data.cards_new) === 0;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    async function startSession() {
      try {
        const res = await fetch(`${API}/api/session/start?learner_id=${LEARNER_ID}`, { method: 'POST' });
        if (!res.ok) {
          const err = await res.json();
          alert(err.detail || 'No cards available');
          return;
        }
        const data = await res.json();
        sessionId = data.session_id;
        totalCards = data.total_cards;
        reviewed = 0;
        sessionCorrect = 0;
        sessionIncorrect = 0;
        showScreen('review');
        loadNextExercise();
      } catch (e) {
        alert('Failed to start session: ' + e.message);
      }
    }

    async function loadNextExercise() {
      try {
        const res = await fetch(`${API}/api/session/next/${sessionId}`);
        if (res.status === 410) {
          showSummary();
          return;
        }
        if (!res.ok) throw new Error('Failed to load exercise');

        currentExercise = await res.json();
        renderExercise(currentExercise);
      } catch (e) {
        console.error(e);
        showSummary();
      }
    }

    function renderExercise(ex) {
      // Update progress
      const done = totalCards - ex.remaining;
      const pct = totalCards > 0 ? (done / totalCards) * 100 : 0;
      document.getElementById('progress-fill').style.width = pct + '%';
      document.getElementById('progress-text').textContent = `${done} / ${totalCards}`;

      // Exercise type and prompt
      document.getElementById('exercise-type').textContent =
        ex.exercise_type.toUpperCase() + (ex.card_reps === 0 ? ' (NEW)' : '');
      document.getElementById('exercise-prompt').textContent = ex.prompt;

      // Hide feedback and rating
      document.getElementById('feedback-container').style.display = 'none';
      document.getElementById('rating-container').style.display = 'none';

      // Show appropriate input
      if (ex.exercise_type === 'mcq' && ex.options) {
        document.getElementById('mcq-container').style.display = 'flex';
        document.getElementById('text-container').style.display = 'none';
        renderMCQOptions(ex.options);
      } else {
        document.getElementById('mcq-container').style.display = 'none';
        document.getElementById('text-container').style.display = 'block';
        const input = document.getElementById('answer-input');
        input.value = '';
        input.focus();
      }

      answerStartTime = Date.now();
    }

    function renderMCQOptions(options) {
      const container = document.getElementById('mcq-container');
      container.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'mcq-option';
        btn.textContent = opt;
        btn.onclick = () => selectMCQ(btn, opt);
        container.appendChild(btn);
      });
    }

    function selectMCQ(btn, value) {
      // Disable further selection
      document.querySelectorAll('.mcq-option').forEach(b => {
        b.style.pointerEvents = 'none';
      });
      btn.classList.add('selected');
      currentResponse = value;
      submitAnswer(value);
    }

    function submitTextAnswer() {
      const input = document.getElementById('answer-input');
      const value = input.value.trim();
      if (!value) return;
      currentResponse = value;
      input.disabled = true;
      document.getElementById('submit-btn').disabled = true;
      submitAnswer(value);
    }

    async function submitAnswer(response) {
      const timeMs = Date.now() - answerStartTime;

      try {
        const res = await fetch(`${API}/api/session/answer/${sessionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            card_id: currentExercise.card_id,
            exercise_id: currentExercise.exercise_id,
            response: response,
            time_ms: timeMs,
          }),
        });

        if (!res.ok) throw new Error('Failed to submit answer');
        const data = await res.json();
        reviewed++;

        showFeedback(data);
      } catch (e) {
        console.error(e);
        alert('Error submitting answer');
      }
    }

    function showFeedback(result) {
      const container = document.getElementById('feedback-container');
      const isCorrect = result.grade === 'correct';

      if (isCorrect) {
        sessionCorrect++;
        container.className = 'feedback correct';
        container.innerHTML = '<strong>Correct!</strong>';
      } else {
        sessionIncorrect++;
        container.className = 'feedback incorrect';
        container.innerHTML = `
          <div>${result.feedback}</div>
          <div class="correct-answer">${result.correct_answer}</div>
        `;
      }
      container.style.display = 'block';

      // Highlight MCQ options
      if (currentExercise.exercise_type === 'mcq' && currentExercise.options) {
        document.querySelectorAll('.mcq-option').forEach(btn => {
          if (btn.textContent === result.correct_answer) {
            btn.classList.add('correct');
          } else if (btn.classList.contains('selected') && !isCorrect) {
            btn.classList.add('incorrect');
          }
        });
      }

      // Show rating buttons
      document.getElementById('rating-container').style.display = 'block';

      // If session is complete after this, auto-advance
      if (result.session_complete) {
        setTimeout(() => showSummary(), 1500);
      }
    }

    function submitRating(rating) {
      // Rating is informational for now (already submitted with auto-rating)
      // In a more advanced version, we'd resubmit with the self-rating
      document.getElementById('rating-container').style.display = 'none';
      loadNextExercise();
    }

    function showSummary() {
      document.getElementById('sum-correct').textContent = sessionCorrect;
      document.getElementById('sum-incorrect').textContent = sessionIncorrect;
      const total = sessionCorrect + sessionIncorrect;
      const pct = total > 0 ? Math.round((sessionCorrect / total) * 100) : 0;
      document.getElementById('sum-accuracy').textContent = pct + '%';
      showScreen('summary');
    }

    function showDashboard() {
      showScreen('dashboard');
      loadStats();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Enter to submit text answer
      if (e.key === 'Enter' && document.getElementById('text-container').style.display !== 'none') {
        const input = document.getElementById('answer-input');
        if (!input.disabled && input.value.trim()) {
          submitTextAnswer();
        }
      }

      // 1-4 for rating
      if (['1', '2', '3', '4'].includes(e.key) &&
          document.getElementById('rating-container').style.display !== 'none') {
        submitRating(parseInt(e.key));
      }
    });

    // Initialize
    loadStats();
  </script>
</body>
</html>
